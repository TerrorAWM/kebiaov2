<?php
// index.php
declare(strict_types=1);
mb_internal_encoding('UTF-8');
session_start();

include_once __DIR__ . '/db.php';

function db(): PDO {
    static $pdo = null;
    if ($pdo === null) {
        $pdo = new PDO(DB_DSN, DB_USER, DB_PASS, [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        ]);
    }
    return $pdo;
}

/* =============== 常用工具函数 =============== */
function json_out($arr, int $code = 200): void {
    http_response_code($code);
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode($arr, JSON_UNESCAPED_UNICODE);
    exit;
}

/* —— 新增：链接登录（无记忆）支持 —— */
function link_login_user(): ?int {
    static $cached = null; // 0=无效，>0=uid
    if ($cached !== null) return $cached === 0 ? null : $cached;

    $sid  = $_GET['sid']  ?? null;
    $pass = $_GET['pass'] ?? null;
    if (!is_string($sid) || !preg_match('/^\d{4,6}$/', $sid))  { $cached = 0; return null; }
    if (!is_string($pass) || !preg_match('/^\d{4}$/',  $pass)) { $cached = 0; return null; }

    $stmt = db()->prepare('SELECT user_id, pin FROM user_accounts WHERE user_id = ? LIMIT 1');
    $stmt->execute([$sid]); $row = $stmt->fetch();
    if (!$row || (string)$row['pin'] !== $pass) { $cached = 0; return null; }

    $cached = (int)$row['user_id'];
    return $cached;
}

function auth_mode(): string {
    if (isset($_SESSION['uid']) && is_numeric($_SESSION['uid'])) return 'session';
    if (link_login_user() !== null) return 'link';
    return 'guest';
}

function is_logged_in(): bool {
    return auth_mode() !== 'guest';
}

function require_login(): int {
    if (isset($_SESSION['uid']) && is_numeric($_SESSION['uid'])) return (int)$_SESSION['uid'];
    $lid = link_login_user(); if ($lid !== null) return $lid;
    header('Location: ?'); exit;
}

function parse_weeks_string(string $s): array {
    $s = trim($s); if ($s === '') return [];
    $parts = preg_split('/\s*,\s*/u', $s);
    $weeks = [];
    foreach ($parts as $p) {
        if (preg_match('/^(\d{1,2})\s*-\s*(\d{1,2})$/', $p, $m)) {
            $a = (int)$m[1]; $b = (int)$m[2]; if ($a > $b) { [$a,$b] = [$b,$a]; }
            for ($i=$a; $i <= $b; $i++) $weeks[] = $i;
        } elseif (preg_match('/^\d{1,2}$/', $p)) {
            $weeks[] = (int)$p;
        }
    }
    $weeks = array_values(array_unique($weeks)); sort($weeks); return $weeks;
}

function calc_week_no(DateTime $now, string $startDateYmd, string $tz): int {
    $start = new DateTime($startDateYmd . ' 00:00:00', new DateTimeZone($tz));
    $now2  = (clone $now)->setTimezone(new DateTimeZone($tz));
    $diffDays = (int)$start->diff($now2)->format('%r%a'); if ($diffDays < 0) return 0; return (int)floor($diffDays / 7) + 1;
}

function time_in_range(string $hhmm, string $start, string $end): bool { return ($hhmm >= $start && $hhmm <= $end); }
function h($s): string { return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }

/* ================== API 区 ================== */
if (isset($_GET['api'])) {
    $api = $_GET['api'];

    if ($api === 'login' && $_SERVER['REQUEST_METHOD'] === 'POST') {
        $uid = $_POST['uid'] ?? ''; $pin = $_POST['pin'] ?? '';
        if (!preg_match('/^\d{4,6}$/', $uid)) json_out(['ok'=>false,'error'=>'ID 必须为 4-6 位数字'], 400);
        if (!preg_match('/^\d{4}$/', $pin))  json_out(['ok'=>false,'error'=>'密码必须为 4 位数字'], 400);
        $stmt = db()->prepare('SELECT user_id, pin, profile FROM user_accounts WHERE user_id = ? LIMIT 1');
        $stmt->execute([$uid]); $row = $stmt->fetch();
        if (!$row || $row['pin'] !== $pin) json_out(['ok'=>false,'error'=>'账号或密码错误'], 403);
        $_SESSION['uid'] = (int)$row['user_id']; json_out(['ok'=>true]);
    }

    if ($api === 'logout') { session_destroy(); header('Location: ?'); exit; }

    if ($api === 'set_client_tz' && $_SERVER['REQUEST_METHOD'] === 'POST') {
        if (auth_mode() === 'link') json_out(['ok'=>false,'error'=>'链接登录模式下不可保存设置'], 403);
        $uid = require_login(); $payload = json_decode(file_get_contents('php://input'), true) ?: [];
        $tz = $payload['tz'] ?? '';
        if ($tz === '' || @new DateTimeZone($tz) === false) json_out(['ok'=>false,'error'=>'无效的时区'], 400);
        $sql = "UPDATE user_accounts SET profile = JSON_SET(COALESCE(profile, JSON_OBJECT()), '$.tz_client', ?) WHERE user_id = ?";
        db()->prepare($sql)->execute([$tz, $uid]); json_out(['ok'=>true]);
    }

    // 保存单元格显示字段设置（["name","teacher","room","weeks"] 的子集）
    if ($api === 'set_cell_fields' && $_SERVER['REQUEST_METHOD'] === 'POST') {
        if (auth_mode() === 'link') json_out(['ok'=>false,'error'=>'链接登录模式下不可保存显示字段设置'], 403);
        $uid = require_login();
        $payload = json_decode(file_get_contents('php://input'), true) ?: [];
        $fields = $payload['fields'] ?? [];
        $allow = ['name','teacher','room','weeks'];
        $clean = [];
        foreach ($fields as $f) if (in_array($f, $allow, true)) $clean[] = $f;
        if (empty($clean)) $clean = ['name','teacher','room'];
        $json = json_encode(array_values(array_unique($clean)), JSON_UNESCAPED_UNICODE);
        $sql = "UPDATE user_accounts SET profile = JSON_SET(COALESCE(profile, JSON_OBJECT()), '$.cell_fields', CAST(? AS JSON)) WHERE user_id = ?";
        db()->prepare($sql)->execute([$json, $uid]);
        json_out(['ok'=>true]);
    }

    // 设置课程备注：参数 { idx:int, note:string }
    if ($api === 'set_note' && $_SERVER['REQUEST_METHOD'] === 'POST') {
        if (auth_mode() === 'link') json_out(['ok'=>false,'error'=>'链接登录模式下不可保存备注'], 403);
        $uid = require_login();
        $payload = json_decode(file_get_contents('php://input'), true) ?: [];
        $idx  = isset($payload['idx']) ? (int)$payload['idx'] : -1;
        $note = trim((string)($payload['note'] ?? ''));
        if ($idx < 0) json_out(['ok'=>false,'error'=>'无效的课程索引'], 400);
        if (mb_strlen($note) > 200) $note = mb_substr($note, 0, 200);
        $path = '$.courses['.$idx.'].note';
        $sql  = "UPDATE user_schedule SET data = JSON_SET(data, '$path', ?) WHERE user_id = ?";
        db()->prepare($sql)->execute([$note, $uid]);
        json_out(['ok'=>true]);
    }

    if ($api === 'me') {
        $uid = require_login();
        $u = db()->prepare('SELECT user_id, profile FROM user_accounts WHERE user_id = ?');
        $u->execute([$uid]); $user = $u->fetch();
        $s = db()->prepare('SELECT data FROM user_schedule WHERE user_id = ?');
        $s->execute([$uid]); $sch = $s->fetch();
        json_out(['ok'=>true, 'user'=>$user, 'schedule'=>$sch]);
    }

    json_out(['ok'=>false,'error'=>'unknown api'], 404);
}

/* ================== 视图逻辑 ================== */
$logged = is_logged_in();
$LOGIN_MODE = auth_mode(); // 'session' | 'link' | 'guest'
$LINK_QS = '';
if ($LOGIN_MODE === 'link') {
    $sid  = (string)($_GET['sid']  ?? '');
    $pass = (string)($_GET['pass'] ?? '');
    $LINK_QS = '&sid=' . rawurlencode($sid) . '&pass=' . rawurlencode($pass);
}

$profile = $schedule = [];
$displayTz = 'UTC';
$calcTz    = 'UTC';
$enabledDays = [1,2,3,4,5,6,7];
$timeslots = [];
$courses   = [];
$startDate = null;
$showAllParam = isset($_GET['all']) ? (bool)$_GET['all'] : false;

// 高亮集合（首屏渲染用；前端仍会实时更新）
$currentHighlight = []; // [day=>[period=>true]]
$nextHighlight    = []; // [day=>[period=>true]]
$nowCourses = [];
$upcomingWithin15 = [];
$upcomingDeadline = null;
$uid_out = 0;

if ($logged) {
    $uid = ($LOGIN_MODE === 'session') ? (int)$_SESSION['uid'] : (int)link_login_user();
    $uid_out = $uid;

    $u = db()->prepare('SELECT profile FROM user_accounts WHERE user_id = ?');
    $u->execute([$uid]); $upro = $u->fetch();
    $profile = $upro ? (json_decode($upro['profile'] ?? '{}', true) ?: []) : [];

    $s = db()->prepare('SELECT data FROM user_schedule WHERE user_id = ?');
    $s->execute([$uid]); $sch = $s->fetch();
    $schedule = $sch ? (json_decode($sch['data'] ?? '{}', true) ?: []) : [];

    // 时区策略
    $tzPref = $profile['tz_pref'] ?? 'timetable';
    $tzClient = $profile['tz_client'] ?? null; $tzCustom = $profile['tz_custom'] ?? null;
    $tzTimetable = ($schedule['tz'] ?? ($profile['tz_timetable'] ?? 'Asia/Shanghai'));
    if ($tzPref === 'client' && $tzClient) { $displayTz = $tzClient; $calcTz = $tzTimetable; }
    elseif ($tzPref === 'custom' && $tzCustom) { $displayTz = $tzCustom; $calcTz = $tzTimetable; }
    else { $displayTz = $tzTimetable; $calcTz = $tzTimetable; }

    $enabledDays = $schedule['enabled_days'] ?? [1,2,3,4,5,6,7]; sort($enabledDays);
    $timeslots = $schedule['timeslots'] ?? [];
    $rawCourses = $schedule['courses'] ?? [];
    $courses = [];
    foreach ($rawCourses as $i=>$c) { $c['__idx'] = $i; $courses[] = $c; }

    $startDate = $schedule['start_date'] ?? null;

    $nowDisplay = new DateTime('now', new DateTimeZone($displayTz));
    $nowCalc    = (clone $nowDisplay)->setTimezone(new DateTimeZone($calcTz));
    $weekNo = $startDate ? calc_week_no($nowCalc, $startDate, $calcTz) : 0;
    $weekdayCalc = (int)$nowCalc->format('N'); // 1..7
    $nowHHMMCalc = $nowCalc->format('H:i');

    // 当前节
    $currentPeriods = [];
    foreach ($timeslots as $slot) {
        $st = $slot['start'] ?? '00:00'; $et = $slot['end'] ?? '00:00';
        if (time_in_range($nowHHMMCalc, $st, $et)) $currentPeriods[] = (int)($slot['idx'] ?? 0);
    }
    foreach ($currentPeriods as $p) $currentHighlight[$weekdayCalc][$p] = true;

    // 当前正在上课（按过滤）
    if (!empty($currentPeriods)) {
        foreach ($courses as $c) {
            $cDay = (int)($c['day'] ?? 0); if ($cDay !== $weekdayCalc) continue;
            $periods = array_map('intval', $c['periods'] ?? []);
            if (!array_intersect($periods, $currentPeriods)) continue;
            $weeksArr = parse_weeks_string((string)($c['weeks'] ?? ''));
            $wtype = strtolower((string)($c['week_type'] ?? 'all'));
            $okWeek = true;
            if (!$showAllParam) {
                $okWeek = in_array($weekNo, $weeksArr, true);
                if ($okWeek && $wtype === 'odd' && $weekNo % 2 === 0) $okWeek = false;
                if ($okWeek && $wtype === 'even' && $weekNo % 2 === 1) $okWeek = false;
            }
            if ($okWeek) $nowCourses[] = $c;
        }
    }

    // 15 分钟内下一节（用于顶部倒计时显示）
    $earliestDiff = null; $nextPeriods = []; $nextStartHHMM = null;
    foreach ($timeslots as $slot) {
        $st = $slot['start'] ?? null; if (!$st) continue;
        if ($st > $nowHHMMCalc) {
            $stDT = DateTime::createFromFormat('Y-m-d H:i', $nowCalc->format('Y-m-d').' '.$st, new DateTimeZone($calcTz));
            $diffMin = (int)floor(($stDT->getTimestamp() - $nowCalc->getTimestamp())/60);
            if ($diffMin >= 0 && $diffMin <= 15) {
                if ($earliestDiff === null || $diffMin < $earliestDiff) {
                    $earliestDiff = $diffMin; $nextStartHHMM = $st; $nextPeriods = [(int)($slot['idx'] ?? 0)];
                } elseif ($earliestDiff !== null && $diffMin === $earliestDiff) {
                    $nextPeriods[] = (int)($slot['idx'] ?? 0);
                }
            }
        }
    }
    if (!empty($nextPeriods)) $nextHighlight[$weekdayCalc] = array_fill_keys($nextPeriods, true);

    if ($nextStartHHMM) {
      $targetCalc = DateTime::createFromFormat('Y-m-d H:i', $nowCalc->format('Y-m-d').' '.$nextStartHHMM, new DateTimeZone($calcTz));
      $targetDisplay = (clone $targetCalc)->setTimezone(new DateTimeZone($displayTz));
      $upcomingDeadline = $targetDisplay->getTimestamp() * 1000; // ms
      foreach ($courses as $c) {
          if ((int)($c['day'] ?? 0) !== $weekdayCalc) continue;
          $periods = array_map('intval', $c['periods'] ?? []);
          if (!in_array((int)$nextPeriods[0], $periods, true)) continue;
          $weeksArr = parse_weeks_string((string)($c['weeks'] ?? ''));
          $wtype = strtolower((string)($c['week_type'] ?? 'all'));
          $ok = true;
          if (!$showAllParam) {
              $ok = in_array($weekNo, $weeksArr, true);
              if ($ok && $wtype === 'odd'  && $weekNo % 2 === 0) $ok = false;
              if ($ok && $wtype === 'even' && $weekNo % 2 === 1) $ok = false;
          }
          if ($ok) $upcomingWithin15[] = $c;
      }
    }
}
?>
<!doctype html>
<html lang="zh-CN" data-bs-theme="auto">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>我的课表</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  /* ======= 桌面优化：整体更紧凑、字体略小 ======= */
  body { background: #f6f7fb; }
  @media (min-width: 992px){
    body{ font-size: .95rem; }
    .card .card-body{ padding: .9rem 1rem; }
    .table th, .table td{ padding:.3rem .35rem; }
    .capsule{ font-size: .95rem; }
    .capsule .cap-meta{ font-size: .78rem; }
  }

  .card { border-radius: 1rem; }
  .sticky-col { position: sticky; left: 0; z-index: 2; background: #fff; white-space: nowrap; }
  .sticky-col .fw-semibold{ white-space: nowrap; }
  .slot-badge { font-size: .75rem; }
  .cell { min-width: 140px; }
  @media (max-width: 576px){ .cell{ min-width: 120px; } }
  /* .now-pill { background: #eef2ff; border: 1px solid #e5e7eb; } */
  .now-pill { background: #ffffffff;}

  /* 表头“周几”确保正常显示（不换行，桌面更清晰） */
  thead.table-light th{text-align:center; white-space:nowrap; }

  /* 高亮边框容器 */
  .cell .cell-content{
    border-radius: .5rem;
    padding: .25rem .4rem;
    transition: border-color .2s, box-shadow .2s, background-color .2s;
  }
  .cell.cell-current .cell-content{ border: 2px solid #16a34a; } /* 绿色：当前 */
  .cell.cell-next    .cell-content{ border: 2px solid #f59e0b; } /* 黄色：下一节 */

  /* 胶囊：两行（标题 + 元信息），标题行含小圆点 */
  .capsule{
    display:inline-flex;
    flex-direction:column;
    align-items:flex-start;
    gap:.15rem;
    border:1px solid var(--cap-bd, #cbd5e1);
    background: var(--cap-bg, #f8fafc);
    border-radius:15px;
    padding:.28rem .6rem .34rem .6rem;
    line-height:1.25;
    max-width:100%;
  }
  .capsule .cap-row{
    display:inline-flex; align-items:center; gap:.4rem;
    white-space:nowrap; max-width:100%;
  }
  .capsule .cap-dot{
    width:.6rem; height:.6rem; border-radius:50%;
    border:1px solid rgba(0,0,0,.06); flex:0 0 auto;
    background: var(--cap-bd, #94a3b8);
  }
  .capsule .cap-text{
    font-weight:600; overflow:hidden; text-overflow:ellipsis; display:inline-block; max-width:16ch;
  }
  .capsule .cap-meta{ font-size:.78rem; opacity:.85; color:#475569; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  /* 单元格内项目与分页器 */
  .cell .cell-item .title { font-weight: 600; }
  .cell .cell-item .meta  { font-size: .8125rem; color: #6b7280; }
  .cell-pager { display:flex; align-items:center; justify-content:center; gap:.5rem; margin-top:.25rem; }
  .cell-pager .btn { padding: 0 .4rem; line-height: 1.2; }
  .cell-pager .page-indicator { font-size:.75rem; color:#6b7280; }
</style>
</head>
<body>
<div class="container py-4">

<?php if (!$logged): ?>
  <!-- 登录卡片 -->
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3 text-center">登录查看课表</h5>
          <form id="loginForm" class="vstack gap-3" onsubmit="return false;">
            <div>
              <label class="form-label">用户 ID（4-6 位数字）</label>
              <input class="form-control form-control-lg" name="uid" inputmode="numeric" pattern="\d{4,6}" required>
            </div>
            <div>
              <label class="form-label">密码（4 位数字）</label>
              <input class="form-control form-control-lg" name="pin" inputmode="numeric" pattern="\d{4}" required>
            </div>
            <button class="btn btn-primary btn-lg w-100" onclick="doLogin()">登录</button>
          </form>
        </div>
      </div>
      <p class="text-center text-muted mt-3">* 首次登录后会自动记录你的客户端时区</p>
    </div>
  </div>

<?php else: ?>
  <?php
    $nowDisplay2 = new DateTime('now', new DateTimeZone($displayTz));
    $weekNo = $startDate ? calc_week_no((clone $nowDisplay2)->setTimezone(new DateTimeZone($calcTz)), $startDate, $calcTz) : 0;

    $weekdayNames = [1=>'星期一','星期二','星期三','星期四','星期五','星期六','星期日'];
    $headerDays   = array_values(array_intersect_key($weekdayNames, array_flip($enabledDays)));
    $headerIdxs   = array_values($enabledDays);

    $displayFields = $profile['cell_fields'] ?? ['name','teacher','room'];
    $showName   = in_array('name', $displayFields, true);
    $showTeacher= in_array('teacher', $displayFields, true);
    $showRoom   = in_array('room', $displayFields, true);
    $showWeeks  = in_array('weeks', $displayFields, true);
  ?>

  <!-- 顶部信息 -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <?php if ($startDate): ?><span class="badge text-bg-light border">开学日期：<?=h($startDate)?></span><?php endif; ?>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#fieldModal">显示字段</button>
      <?php if ($LOGIN_MODE === 'session'): ?>
        <a class="btn btn-outline-secondary btn-sm" href="?api=logout">退出</a>
      <?php elseif ($LOGIN_MODE === 'link'): ?>
        <span class="badge text-bg-warning">链接登录（无记忆）</span>
      <?php endif; ?>
    </div>
  </div>

  <!-- 日期时间 + 第几周 -->
  <div class="text-center mb-3">
    <h2 class="mb-1"><span id="nowTime" data-tz="<?=h($displayTz)?>"></span></h2>
    <div class="text-muted">
      <?php if ($startDate): ?>当前第 <b><?= (int)$weekNo ?></b> 周<?php else: ?><span class="text-warning">（尚未设置课表开始日期）</span><?php endif; ?>
    </div>
  </div>

  <!-- 正在上课 / 即将开始 -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between">
        <div class="pe-3 flex-grow-1">
          <div class="fw-bold mb-1"></div>
          <?php if (!empty($nowCourses)): ?>
            <?php
              $first = $nowCourses[0]; $extra = count($nowCourses) - 1;
              $capDay = (int)($first['day'] ?? 0);
              $firstPi = (int)(($first['periods'][0] ?? 1));
              $capStart = $timeslots[$firstPi - 1]['start'] ?? '';
              $teacherRoomTop = implode(' · ', array_filter([(string)($first['teacher'] ?? ''), (string)($first['room'] ?? '')], fn($x)=>$x!==''));
            ?>
            <div class="now-pill p-2 rounded d-flex align-items-center justify-content-between">
              <div>
                <!-- 顶部胶囊：两行（课名 + 教师·教室） -->
                <span class="capsule" data-capsule
                      data-day="<?= $capDay ?>"
                      data-start="<?= h($capStart) ?>">
                  <span class="cap-row">
                    <i class="cap-dot"></i>
                    <span class="cap-text"><?= h($first['name'] ?? '课程') ?></span>
                  </span>
                  <?php if ($teacherRoomTop !== ''): ?>
                    <span class="cap-meta"><?= h($teacherRoomTop) ?></span>
                  <?php endif; ?>
                </span>
                <?php if ($extra > 0): ?>
                  <a href="#" class="ms-2" data-bs-toggle="modal" data-bs-target="#nowModal">+<?= $extra ?></a>
                <?php endif; ?>
              </div>
              <?php if ($upcomingDeadline): ?>
                <small class="text-muted ms-3">即将开始：<span id="nextCountdown" data-deadline="<?= (int)$upcomingDeadline ?>"></span></small>
              <?php endif; ?>
            </div>
          <?php else: ?>
            <div class="text-muted">当前无课程
              <?php if ($upcomingDeadline): ?>
                ，<span>即将开始：<span id="nextCountdown" data-deadline="<?= (int)$upcomingDeadline ?>"></span></span>
                <?php if (count($upcomingWithin15)>0): $firstU=$upcomingWithin15[0]; $extraU=count($upcomingWithin15)-1; ?>
                  <div class="mt-2">
                    去 <b><?=h($firstU['room'] ?? '教室')?></b>
                    <?php if ($extraU>0): ?>
                      <a href="#" class="ms-2" data-bs-toggle="modal" data-bs-target="#upcomingModal">+<?= $extraU ?> 门</a>
                    <?php endif; ?>
                  </div>
                <?php endif; ?>
              <?php endif; ?>
            </div>
          <?php endif; ?>
        </div>
        <div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="toggleAll" <?= $showAllParam ? 'checked' : '' ?>
                onchange="location.search = buildSearch(this.checked);">
            <label class="form-check-label" for="toggleAll">显示全部课程</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 课表 -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered align-middle table-sm">
          <thead class="table-light">
            <tr>
              <th class="sticky-col">时间 / 节次</th>
              <?php foreach ($headerDays as $dname): ?><th class="text-center"><?=h($dname)?></th><?php endforeach; ?>
            </tr>
          </thead>
          <tbody>
          <?php
            // day -> period -> 课程列表（已按“仅本周/全部”过滤）
            $grid = []; foreach ($headerIdxs as $didx) $grid[$didx] = [];
            foreach ($courses as $c) {
                $d = (int)($c['day'] ?? 0); if (!in_array($d, $headerIdxs, true)) continue;
                $weeksArr = parse_weeks_string((string)($c['weeks'] ?? ''));
                $wtype = strtolower((string)($c['week_type'] ?? 'all'));
                $ok = true;
                if (!$showAllParam && $startDate) {
                    $ok = in_array($weekNo, $weeksArr, true);
                    if ($ok && $wtype === 'odd'  && $weekNo % 2 === 0) $ok = false;
                    if ($ok && $wtype === 'even' && $weekNo % 2 === 1) $ok = false;
                }
                if (!$ok) continue;
                $periods = array_map('intval', $c['periods'] ?? []);
                foreach ($periods as $pi) { $grid[$d][$pi] = $grid[$d][$pi] ?? []; $grid[$d][$pi][] = $c; }
            }
          ?>

          <?php foreach ($timeslots as $slot): ?>
            <?php $pi = (int)$slot['idx']; $label = sprintf('%s-%s', $slot['start'], $slot['end']); ?>
            <tr>
              <th class="sticky-col bg-white">
                <div class="d-flex flex-column">
                  <span class="fw-semibold"><?=h($label)?></span>
                  <span class="text-muted small">第 <?= $pi ?> 节</span>
                </div>
              </th>
              <?php foreach ($headerIdxs as $didx): ?>
                <?php
                  $list = $grid[$didx][$pi] ?? [];
                  $cellCls = '';
                  if (!empty($currentHighlight[$didx][$pi] ?? null)) $cellCls = 'cell-current';
                  elseif (!empty($nextHighlight[$didx][$pi] ?? null)) $cellCls = 'cell-next';
                  $dataCourses = !empty($list) ? h(json_encode($list, JSON_UNESCAPED_UNICODE)) : '';
                ?>
                <td
                  class="cell <?= $cellCls ?>"
                  data-day="<?= $didx ?>"
                  data-period="<?= $pi ?>"
                  data-start="<?= h($slot['start'] ?? '') ?>"
                  <?= $dataCourses ? 'data-courses="'.$dataCourses.'"' : '' ?>
                  data-page="0"
                  onclick="openCellModal(this)"
                  style="cursor:pointer;"
                >
                  <div class="cell-content">
                    <?php if (empty($list)): ?>
                      <span class="text-muted"></span>
                    <?php else: ?>
                      <div class="small text-muted">加载中…</div>
                    <?php endif; ?>
                  </div>
                </td>
              <?php endforeach; ?>
            </tr>
          <?php endforeach; ?>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal：当前时刻的其它课程（胶囊仅课程名） -->
  <div class="modal fade" id="nowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">当前时段其他课程</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button></div>
        <div class="modal-body">
          <?php if (!empty($nowCourses) && count($nowCourses) > 1): ?>
            <div class="list-group">
              <?php foreach (array_slice($nowCourses, 1) as $c): ?>
                <?php
                  $d = (int)($c['day'] ?? 0);
                  $firstPi = (int)(($c['periods'][0] ?? 1));
                  $st = $timeslots[$firstPi - 1]['start'] ?? '';
                  $teacherRoom = implode(' · ', array_filter([(string)($c['teacher'] ?? ''), (string)($c['room'] ?? '')], fn($x)=>$x!==''));
                ?>
                <div class="list-group-item">
                  <span class="capsule" data-capsule data-day="<?= $d ?>" data-start="<?= h($st) ?>">
                    <span class="cap-row">
                      <i class="cap-dot"></i>
                      <span class="cap-text"><?=h($c['name'] ?? '')?></span>
                    </span>
                  </span>
                  <?php if ($teacherRoom !== ''): ?>
                    <div class="text-muted small mt-1"><?=h($teacherRoom)?></div>
                  <?php endif; ?>
                  <?php if (!empty($c['note'] ?? '')): ?><div class="small text-muted">备注：<?=h($c['note'])?></div><?php endif; ?>
                </div>
              <?php endforeach; ?>
            </div>
          <?php else: ?><div class="text-muted">暂无</div><?php endif; ?>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal：15 分钟内即将开始（胶囊仅课程名） -->
  <div class="modal fade" id="upcomingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">即将开始（15 分钟内）</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button></div>
        <div class="modal-body">
          <?php if (!empty($upcomingWithin15)): ?>
            <div class="list-group">
              <?php foreach ($upcomingWithin15 as $c): ?>
                <?php
                  $d = (int)($c['day'] ?? 0);
                  $firstPi = (int)(($c['periods'][0] ?? 1));
                  $st = $timeslots[$firstPi - 1]['start'] ?? '';
                  $teacherRoom = implode(' · ', array_filter([(string)($c['teacher'] ?? ''), '去 '.(string)($c['room'] ?? '')], fn($x)=>trim($x)!==''));
                ?>
                <div class="list-group-item">
                  <span class="capsule" data-capsule data-day="<?= $d ?>" data-start="<?= h($st) ?>">
                    <span class="cap-row">
                      <i class="cap-dot"></i>
                      <span class="cap-text"><?=h($c['name'] ?? '')?></span>
                    </span>
                  </span>
                  <?php if ($teacherRoom !== ''): ?>
                    <div class="text-muted small mt-1"><?=h($teacherRoom)?></div>
                  <?php endif; ?>
                  <?php if (!empty($c['note'] ?? '')): ?><div class="small text-muted">备注：<?=h($c['note'])?></div><?php endif; ?>
                </div>
              <?php endforeach; ?>
            </div>
          <?php else: ?><div class="text-muted">暂无</div><?php endif; ?>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal：单元格课程列表（含备注编辑；胶囊仅课程名） -->
  <div class="modal fade" id="cellModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">该时段课程</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button></div>
        <div class="modal-body" id="cellModalBody"></div>
      </div>
    </div>
  </div>

  <!-- Modal：显示字段设置 -->
  <div class="modal fade" id="fieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">课表单元格显示字段</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button></div>
        <div class="modal-body">
          <div class="form-check"><input class="form-check-input" type="checkbox" id="f_name"   <?= $showName?'checked':'' ?>><label class="form-check-label" for="f_name">课程名</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="f_teacher"<?= $showTeacher?'checked':'' ?>><label class="form-check-label" for="f_teacher">教师</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="f_room"  <?= $showRoom?'checked':'' ?>><label class="form-check-label" for="f_room">教室</label></div>
          <div class="form-check"><input class="form-check-input" type="checkbox" id="f_weeks" <?= $showWeeks?'checked':'' ?>><label class="form-check-label" for="f_weeks">周数</label></div>
          <div class="text-muted small mt-2">* 默认：课程名、教师、教室。点击单元格可查看完整信息与备注。</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="saveFields()">保存</button>
        </div>
      </div>
    </div>
  </div>

<?php endif; ?>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= 链接登录前置变量 & 工具 ========= */
const LINK_MODE = <?= $LOGIN_MODE === 'link' ? 'true' : 'false' ?>;
const SID  = <?= json_encode($_GET['sid']  ?? null) ?>;
const PASS = <?= json_encode($_GET['pass'] ?? null) ?>;
const LINK_QS = LINK_MODE ? (`&sid=${encodeURIComponent(SID)}&pass=${encodeURIComponent(PASS)}`) : '';

function buildApiUrl(name){
  return `?api=${name}${LINK_QS}`;
}
function buildSearch(showAll){
  const sp = new URLSearchParams(window.location.search);
  if (showAll) sp.set('all','1'); else sp.delete('all');
  if (LINK_MODE){ sp.set('sid', SID); sp.set('pass', PASS); }
  return '?' + sp.toString();
}

/* ========= 其余前端逻辑 ========= */
const USER_ID = <?= (int)$uid_out ?>; // 用于颜色种子
const NAME_MAX = 5;                   // 课程名最大显示字符（超出加省略号）

function clampName(s, n=NAME_MAX){
  if(!s) return '';
  const arr = Array.from(s); // 兼容中英文与emoji的码点长度
  return arr.length > n ? arr.slice(0, n).join('') + '…' : s;
}

async function doLogin(){
  const f = document.querySelector('#loginForm'); const fd = new FormData(f);
  const r = await fetch(buildApiUrl('login'), {method:'POST', body:fd}); const j = await r.json();
  if(!j.ok){ alert(j.error || '登录失败'); return; } location.reload();
}

// 登录后：自动上报客户端时区（链接登录下不保存）
(async function reportTZ(){
  <?php if ($logged): ?>
  try{
    if (LINK_MODE) return; // 链接登录：不保存
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    if(tz){ await fetch(buildApiUrl('set_client_tz'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({tz})}); }
  }catch(e){}
  <?php endif; ?>
})();

function openCellModal(td){
  const raw = td.getAttribute('data-courses'); if(!raw) return; let list = [];
  try{ list = JSON.parse(raw); }catch(e){}
  const day = parseInt(td.getAttribute('data-day')||'0',10);
  const body = document.querySelector('#cellModalBody'); body.innerHTML='';
  if(!list.length){ body.innerHTML = '<div class="text-muted">暂无</div>'; }
  else {
    const wrap = document.createElement('div'); wrap.className='list-group';
    list.forEach(c=>{
      const item = document.createElement('div'); item.className='list-group-item';

      // 胶囊（详细：只显示课程名）
      const periods = (c.periods||[]).map(x=>parseInt(x,10)).sort((a,b)=>a-b);
      const startHHMM = periodStartFromList(periods) || td.getAttribute('data-start') || '';
      const cap = buildCapsule(day, startHHMM, c.name||'', /*metaText*/'', /*withMeta*/false);
      item.appendChild(cap);

      // 教师 · 教室
      const teacherRoom = [c.teacher||'', c.room||''].filter(Boolean).join(' · ');
      if (teacherRoom){
        const meta = document.createElement('div'); meta.className='text-muted small mt-1'; meta.textContent = teacherRoom;
        item.appendChild(meta);
      }

      // 备注
      if ((c.note||'')!==''){
        const noteTxt = document.createElement('div'); noteTxt.className='small text-muted'; noteTxt.textContent='备注：'+c.note;
        item.appendChild(noteTxt);
      }
      const noteWrap = document.createElement('div'); noteWrap.className='mt-2';
      const ta = document.createElement('textarea'); ta.className='form-control'; ta.rows=2; ta.value = c.note || '';
      const btn = document.createElement('button'); btn.className='btn btn-sm btn-primary mt-2'; btn.textContent='保存备注';
      btn.onclick = async ()=>{ await saveNote(c.__idx, ta.value); };
      noteWrap.appendChild(ta); noteWrap.appendChild(btn);
      item.appendChild(noteWrap);

      wrap.appendChild(item);
    });
    body.appendChild(wrap);
  }
  const modal = new bootstrap.Modal(document.getElementById('cellModal')); modal.show();
}

async function saveNote(idx, note){
  try{
    const r = await fetch(buildApiUrl('set_note'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({idx, note})});
    const j = await r.json(); if(!j.ok) throw new Error(j.error||'保存失败');
    alert('备注已保存');
  }catch(e){ alert(e.message||'保存失败'); }
}

async function saveFields(){
  const fields=[]; if(f_name.checked) fields.push('name'); if(f_teacher.checked) fields.push('teacher'); if(f_room.checked) fields.push('room'); if(f_weeks.checked) fields.push('weeks');
  try{
    const r = await fetch(buildApiUrl('set_cell_fields'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({fields})});
    const j = await r.json(); if(!j.ok) throw new Error(j.error||'保存失败');
    location.reload();
  }catch(e){ alert(e.message||'保存失败'); }
}

// 倒计时（若存在）
(function initCountdown(){
  const el = document.getElementById('nextCountdown'); if(!el) return;
  const deadline = parseInt(el.getAttribute('data-deadline'),10); if(!deadline) return;
  function tick(){
    const now = Date.now(); let diff = Math.max(0, Math.floor((deadline - now)/1000));
    const m = Math.floor(diff/60), s = diff%60; el.textContent = (m.toString().padStart(2,'0')+':'+s.toString().padStart(2,'0'));
  }
  tick(); setInterval(tick, 1000);
})();

/* ===== 顶部时间每30秒自动刷新 ===== */
(function initClock(){
  const el = document.getElementById('nowTime'); if(!el) return;
  const tz = el.getAttribute('data-tz') || Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
  function fmtNow(){
    const now = new Date();
    const fmt = new Intl.DateTimeFormat('zh-CN', {
      timeZone: tz, hour12:false,
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit'
    }).formatToParts(now);
    const parts = Object.fromEntries(fmt.map(p=>[p.type,p.value]));
    el.textContent = `${parts.year}年${parts.month}月${parts.day}日 ${parts.hour}:${parts.minute}`;
  }
  fmtNow();
  setInterval(fmtNow, 30_000);
})();

/* ======= period idx -> startHHMM ======= */
const TIMESLOTS = <?= json_encode(array_values($timeslots), JSON_UNESCAPED_UNICODE) ?>; // [{idx,start,end},...]
const PERIOD_START = {};
for (const s of TIMESLOTS){ if (s && s.idx!=null && s.start) PERIOD_START[parseInt(s.idx,10)] = String(s.start); }
function periodStartFromList(periods){
  const arr = (periods||[]).map(p=>PERIOD_START[p]).filter(Boolean).sort();
  return arr.length ? arr[0] : '';
}

/* ===== 单元格内分页（每页2门；>2门出现分页器） ===== */
const DISPLAY_FIELDS = {
  name: <?= $showName?'true':'false' ?>,
  teacher: <?= $showTeacher?'true':'false' ?>,
  room: <?= $showRoom?'true':'false' ?>,
  weeks: <?= $showWeeks?'true':'false' ?>
};

function buildCapsule(day, startHHMM, text, metaText, withMeta){
  // 稳定配色：seed = userId | day | startHHMM
  const seed = `${USER_ID}|${day}|${startHHMM||''}`;
  const color = colorFromSeed(seed);

  const span = document.createElement('span');
  span.className='capsule';
  span.style.setProperty('--cap-bg', color.bg);
  span.style.setProperty('--cap-bd', color.bd);

  // 第一行：小圆点 + 课程名（>5 截断 + …）
  const row = document.createElement('span'); row.className='cap-row';
  const dot = document.createElement('i');   dot.className='cap-dot';
  const t   = document.createElement('span'); t.className='cap-text'; t.textContent = clampName(text || '');
  row.appendChild(dot); row.appendChild(t);
  span.appendChild(row);

  // 第二行（可选）：教师 · 教室
  if (withMeta && metaText){
    const m = document.createElement('span'); m.className='cap-meta'; m.textContent = metaText;
    span.appendChild(m);
  }
  return span;
}

function buildCellItem(c, day){
  // 表格单元格：胶囊（两行：课名 + 教师·教室） + 可选周数
  const wrap = document.createElement('div'); wrap.className='cell-item vstack gap-1';
  const periods = (c.periods||[]).map(x=>parseInt(x,10)).sort((a,b)=>a-b);
  const startHHMM = periodStartFromList(periods);
  const teacherRoom = [c.teacher||'', c.room||''].filter(Boolean).join(' · ');
  const cap = buildCapsule(day, startHHMM, c.name||'', teacherRoom, /*withMeta=*/true);
  wrap.appendChild(cap);

  if (DISPLAY_FIELDS.weeks && c.weeks){
    const metaWeeks = document.createElement('div'); metaWeeks.className='meta text-truncate';
    metaWeeks.textContent = '周: ' + String(c.weeks);
    wrap.appendChild(metaWeeks);
  }
  return wrap;
}

function renderCell(td){
  const holder = td.querySelector('.cell-content') || td;
  const raw = td.getAttribute('data-courses'); if(!raw){ holder.innerHTML = '<span class="text-muted"></span>'; return; }
  let list = []; try{ list = JSON.parse(raw); }catch(e){}
  const per = 2;
  const totalPages = Math.max(1, Math.ceil(list.length / per));
  let page = parseInt(td.getAttribute('data-page')||'0', 10);
  if (isNaN(page)) page = 0;
  page = Math.max(0, Math.min(page, totalPages-1));
  td.setAttribute('data-page', String(page));

  const start = page * per;
  const items = list.slice(start, start + per);
  const day = parseInt(td.getAttribute('data-day')||'0',10);

  const box = document.createElement('div'); box.className = 'vstack gap-2';
  if (!items.length){
    box.innerHTML = '<span class="text-muted"></span>';
  } else {
    items.forEach(c=> box.appendChild(buildCellItem(c, day)));
  }

  if (list.length > per){
    const pager = document.createElement('div'); pager.className='cell-pager';
    const prev = document.createElement('button'); prev.type='button'; prev.className='btn btn-sm btn-outline-secondary'; prev.textContent='‹';
    const next = document.createElement('button'); next.type='button'; next.className='btn btn-sm btn-outline-secondary'; next.textContent='›';
    const indi = document.createElement('span'); indi.className='page-indicator'; indi.textContent = (page+1) + '/' + totalPages;

    prev.onclick = (ev)=>{ ev.stopPropagation(); changeCellPage(td, -1); };
    next.onclick = (ev)=>{ ev.stopPropagation(); changeCellPage(td, +1); };

    pager.appendChild(prev); pager.appendChild(indi); pager.appendChild(next);
    box.appendChild(pager);
  }

  holder.innerHTML = '';
  holder.appendChild(box);
}

function changeCellPage(td, dir){
  const total = (()=>{ const raw = td.getAttribute('data-courses'); if(!raw) return 1; let l=[]; try{l=JSON.parse(raw);}catch(e){} return Math.max(1, Math.ceil(l.length/2)); })();
  let p = parseInt(td.getAttribute('data-page')||'0', 10);
  if (isNaN(p)) p = 0;
  p += dir;
  if (p < 0) p = total - 1;
  if (p >= total) p = 0;
  td.setAttribute('data-page', String(p));
  renderCell(td);
}

(function initCells(){
  document.querySelectorAll('td.cell[data-courses]').forEach(td => renderCell(td));
  // 服务器端输出的 data-capsule 胶囊（顶部/弹窗）统一上色 + 统一标题截断
  document.querySelectorAll('[data-capsule]').forEach(el=>{
    const day = parseInt(el.getAttribute('data-day')||'0',10);
    const st  = el.getAttribute('data-start') || '';
    const color = colorFromSeed(`${USER_ID}|${day}|${st}`);
    el.style.setProperty('--cap-bg', color.bg);
    el.style.setProperty('--cap-bd', color.bd);
    const t = el.querySelector('.cap-text'); if (t){ t.textContent = clampName(t.textContent || ''); }
  });
})();

/* ===== 实时高亮：当前（绿） + 下一节（黄）；跨天回滚下一天第一门 ===== */
const CALC_TZ  = "<?=h($calcTz)?>";
const DAYS     = <?= json_encode(array_values($enabledDays), JSON_UNESCAPED_UNICODE) ?>;

function nowInTZ(tz){
  const f = new Intl.DateTimeFormat('en-GB', {
    timeZone: tz, hour12:false,
    year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', weekday:'short'
  });
  const parts = Object.fromEntries(f.formatToParts(new Date()).map(p=>[p.type,p.value]));
  const map = {Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6, Sun:7};
  return { hhmm: `${parts.hour}:${parts.minute}`, day: map[parts.weekday]||1 };
}
function getCell(day, period){ return document.querySelector(`td.cell[data-day="${day}"][data-period="${period}"]`); }
function cellHasCourse(cell){
  if(!cell) return false;
  const raw = cell.getAttribute('data-courses');
  if(!raw) return false;
  try{ const list = JSON.parse(raw); return Array.isArray(list) && list.length>0; }catch(e){ return false; }
}
function sortSlots(slots){
  return [...slots].sort((a,b)=>{
    if (a.start === b.start) return (a.idx||0)-(b.idx||0);
    return a.start > b.start ? 1 : -1;
  });
}
function clearHL(){
  document.querySelectorAll('td.cell.cell-current, td.cell.cell-next').forEach(td=>{
    td.classList.remove('cell-current','cell-next');
  });
}
function markCurrent(day, hhmm, slots){
  const curr = slots.filter(s => hhmm >= s.start && hhmm <= s.end).map(s => s.idx);
  curr.forEach(p=>{
    const td = getCell(day, p);
    if (cellHasCourse(td)) td.classList.add('cell-current');
  });
}
function findNext(dayToday, hhmm, slots){
  const todayIdx = Math.max(0, DAYS.indexOf(dayToday));
  for (let offset=0; offset < DAYS.length; offset++){
    const day = DAYS[(todayIdx + offset) % DAYS.length];
    const slotList = (offset === 0) ? slots.filter(s => s.start > hhmm) : slots;
    for (const s of slotList){
      const td = getCell(day, s.idx);
      if (cellHasCourse(td)) return { day, period: s.idx };
    }
  }
  return null;
}
(function liveHighlight(){
  const slots = sortSlots(TIMESLOTS);
  function tick(){
    clearHL();
    const {hhmm, day} = nowInTZ(CALC_TZ);
    markCurrent(day, hhmm, slots);
    const nxt = findNext(day, hhmm, slots);
    if (nxt){
      const td = getCell(nxt.day, nxt.period);
      if (td) td.classList.add('cell-next');
    }
  }
  tick();
  setInterval(tick, 30 * 1000);
})();

/* ======= 稳定配色算法（用户ID + 开课时间） =======
   1) 对 seed 做简单hash（djb2）
   2) H 从hash取 0..359；S/L 设为固定柔和值（pastel）
   3) 生成两个色：边框较深，背景较浅
*/
function djb2(str){
  let h = 5381;
  for (let i=0; i<str.length; i++) { h = ((h<<5)+h) + str.charCodeAt(i); h |= 0; }
  return h >>> 0;
}
function hsl(h,s,l){ return `hsl(${Math.round(h)}, ${Math.round(s)}%, ${Math.round(l)}%)`; }
function colorFromSeed(seed){
  const hv = djb2(String(seed));
  const h  = hv % 360;
  const sBg= 70,  lBg= 92;  // 背景淡色
  const sBd= 65,  lBd= 55;  // 边框/圆点
  return { bg: hsl(h, sBg, lBg), bd: hsl(h, sBd, lBd) };
}
</script>
</body>
</html>

在左边加入一个圆形按钮 点击后会跳转至实验课表 lab.php
在他的上面加入一个分享按钮 
按钮中有 
创建链接
和管理链接 

每个都有对应的modal弹窗 

分享功能modal有 
时区设置功能 
随客户端改变 
本客户端时区
自定义时区 
可以根据america asia搜索然后一步一步直到选择好时区 可以是输入框下拉框结合

分享最大访问日期
无限制 
1-180天 
和手动选择日期 

最大访问次数
无限制
和自定义
创建成功会有一个链接 


显示设置
 课名
 教师
 教室
 周数

然后是管理链接 
邀请码	访问期限	最大访问次数	访问次数 操作（删除）

每个课表都只能创建最多5个链接 
但是后台数据库保存这个信息 
如果没有链接次数就是5如果有数字就是数字 如果是nolimit就是无限制 

并且要为这个功能添加新数据库

而右侧有一个设置按钮 圆形
点击后有个设置按钮 跳转到edit.php

并且要检测页面中有没有下面的代码 如果有就把设置按钮往上面挪
不要让他当到这个按钮 并且这个按钮是页面加载完成才显示的 所以设置按钮要实时监听 
<div id="hit-fab">
      <button id="hit-fab-toggle" title="HIT">HIT</button>
      <div id="hit-fab-panel" role="dialog" aria-label="HIT">
        <div class="hit-fab-title">常用入口</div>
        <div class="hit-fab-row">
          <button class="hit-fab-btn" data-goto="intranet">访问HIT内网</button>
          <button class="hit-fab-btn" data-goto="extranet">访问HIT外网</button>
          <button class="hit-fab-btn" data-goto="wlan">访问HIT-WLAN</button>
        </div>
        
        <div class="hit-fab-sec">
          <div class="hit-fab-kv"><span class="hit-fab-meta" id="hit-fab-site-meta">当前站点：非HIT</span><span></span></div>
        </div>
      </div>
    </div>


分享功能在这个页面不需要让被分享着登录 而是让他专门跳转到share_kb.php中 
并且邀请码和链接都带4数字密码 随机 不能和主密码一样 
并且给我完整的代码 
以下是mysql

CREATE TABLE `shared_links` (
  `id` bigint(20) UNSIGNED NOT NULL,
  `user_id` int(10) UNSIGNED NOT NULL,
  `token` char(32) NOT NULL,
  `share_pass` char(4) NOT NULL,
  `tz_mode` enum('client_dynamic','client_fixed','custom') NOT NULL DEFAULT 'client_dynamic',
  `tz_value` varchar(64) DEFAULT NULL,
  `display_fields` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin DEFAULT NULL CHECK (json_valid(`display_fields`)),
  `max_visits` int(10) UNSIGNED DEFAULT NULL,
  `visit_count` int(10) UNSIGNED NOT NULL DEFAULT 0,
  `expires_at` datetime DEFAULT NULL,
  `disabled` tinyint(1) NOT NULL DEFAULT 0,
  `created_at` timestamp NOT NULL DEFAULT current_timestamp()
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

--
-- 转储表的索引
--

--
-- 表的索引 `shared_links`
--
ALTER TABLE `shared_links`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `uk_token` (`token`),
  ADD KEY `idx_user` (`user_id`),
  ADD KEY `idx_valid` (`disabled`,`expires_at`);
